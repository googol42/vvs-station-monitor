<!DOCTYPE html>
<html>
<head>
    <title>VVS Station Monitor</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="vvs.css">
    <link rel="stylesheet" type="text/css" href="fade.css">
    <script src="fade.js"></script>
    <script>
        /* Engelboldstraße 5000008 */
        /* Kaltental 5006009 */
        /* Im Elsental 5002578 */
        /* Österfeld */
        var stations = [
                    ['5000008', ['Vaihingen', 'Vaihingen Bf'], ['']],
                    ['5006009', ['Mineralbäder', 'Fellbach', 'Fellbach Lutherkirche', 'Heslach Vogelrain', 'Heslach'], ['Vaihingen', 'Vaihingen Bf', '- Betriebsfahrt -']],
                    ['5002578', ['Rohr Mitte', 'Leinfelden'], ['']],
                    ['5006027', [''], ['']]
        ];

        function init() {
            onloadFade();
            for (var index = 0; index < stations.length; index++) {
              var stationDiv = document.createElement('div');
              stationDiv.id = stations[index][0];
              stationDiv.classList.add('station');
              var stationNameDiv = document.createElement('div');
              stationNameDiv.classList.add('stationName');
              stationNameDiv.id = "stationName" + stations[index][0];
              stationDiv.appendChild(stationNameDiv);
              var connectionsDiv = document.createElement('div');
              connectionsDiv.id = "connections" + stations[index][0];
              connectionsDiv.classList.add('connections');
              stationDiv.appendChild(connectionsDiv);
              document.getElementById('stations').appendChild(stationDiv);
              updateStationTimeout(stations[index][0], stations[index][1], stations[index][2]);
            }
            updateClock();
            document.body.addEventListener('touchstart', touchHandler, false);
        }

        function touchHandler(event) {
            for (var index = 0; index < stations.length; index++) {
                updateStation(stations[index][0], stations[index][1], stations[index][2]);
            }
            document.getElementById('update').style = "color: green;";
            setTimeout(function() { document.getElementById('update').style = "color: black;"; }, 2000);
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            setTimeout(function() {updateClock();}, 1 * 1000);
        }

        function updateTimeToUpdate(time) {
            setTimeout(function() {
                time = time - 1000;
                if (0 <= time) {
                    document.getElementById('update').innerText = "Reguläres Update in " + time / 1000 + " s";
                    updateTimeToUpdate(time);
                }
            }, 1000);
        }

        function updateStationTimeout(stationId, directions, ignoreDirections) {
            var time = 30 * 1000;
            setTimeout(function() {updateStationTimeout(stationId, directions, ignoreDirections);}, time);
            updateTimeToUpdate(time);
            updateStation(stationId, directions, ignoreDirections)
        }

        function updateStation(stationId, directions, ignoreDirections) {
            var vvsRequest = new XMLHttpRequest();
            vvsRequest.open("GET", "https://efa-api.asw.io/api/v1/station/" + stationId + "/departures/", true);
            vvsRequest.setRequestHeader("Content-type","application/json");
            vvsRequest.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    addConnections(stationId, directions, ignoreDirections, this.responseText);
                }
            }
            vvsRequest.send();
        }

        function addConnections(stationId, directions, ignoreDirections, connections) {
            var stationDiv = document.getElementById("stationName" + stationId);
            var connectionsDiv = document.getElementById('connections' + stationId);
            while (connectionsDiv.firstChild) {
                connectionsDiv.removeChild(connectionsDiv.firstChild);
            }
            var numberOfStationsAdded = 0;
            for (var i = 0; i < 10000; i++) {
                var connection = JSON.parse(connections)[i];
                stationDiv.innerText = connection['stopName'];
                if (!arrayContains(connection['direction'], directions) ) {
                    if (!arrayContains(connection['direction'], ignoreDirections)) {
                        console.log('Connection excluded', connection['direction'], directions);
                        var debugging = document.getElementById('debugging');
                        debugging.innerText = "Folgende Verbindungen wurden nicht berücksichtigt (Fehler!):";
                        var debuggingUl = document.getElementById('debuggingUl');
                        console.log(debuggingUl);
                        var p = document.createElement("li");
                        p.innerText = "Von " + connection['stopName'] + " nach " + connection['direction'] + ". Erlaubte Ziele: " + directions;
                        debuggingUl.appendChild(p);
                    }
                    continue;
                }
                var connectionDiv = document.createElement('div');
                connectionDiv.classList.add('connection');

                var timeSpan = document.createElement("span");
                timeSpan.classList.add('time-span');
                connectionDiv.appendChild(timeSpan);
                timeSpan.appendChild(getTime(connection));
                timeSpan.appendChild(getDelay(connection));
                connectionDiv.appendChild(addDirection(connection));
                connectionsDiv.appendChild(connectionDiv);
                numberOfStationsAdded++;
                if (numberOfStationsAdded === 4) {
                    break;
                }
            }
        }


        function getTime(connection) {
            var connectionP = document.createElement("span");
            var hour = connection['departureTime']['hour'];
            if (hour < 10) {
                hour = "0" + hour;
            }
            var minutes = connection['departureTime']['minute'];
            if (minutes < 10) {
                minutes = "0" + minutes;
            }
            connectionP.innerText = hour + ":" + minutes;
            return connectionP;
        }

        function getDelay(connection) {
            var delaySpan = document.createElement("span");
            var delay = connection['delay'];
            delaySpan.innerText = " +" + delay;
            if (5 < delay) {
                delaySpan.classList.add('delayRed');
            } else if (1 < delay) {
                delaySpan.classList.add('delayOrange');
            } else {
                delaySpan.innerText = '';
            }
            return delaySpan;
        }

        function addDirection(connection) {
            var root = document.createElement("span");
            var arrowP = document.createElement("span");
            var image = document.createElement('img');
            var directionP  = document.createElement("span");
            root.appendChild(arrowP);
            root.appendChild(image);
            root.appendChild(directionP);

            var number_ = connection['number'];
            if (number_.startsWith('S')) {
                image.src = 'https://www.vvs.de/typo3conf/ext/vvs_efa_monitor/Resources/Public/Images/icon.sbahn.20.png';
            } else if (number_.startsWith('U')) {
                image.src = 'https://www.vvs.de/typo3conf/ext/vvs_efa_monitor/Resources/Public/Images/icon.ubahn.20.png'
            } else {
                image.src = 'https://www.vvs.de/typo3conf/ext/vvs_efa_monitor/Resources/Public/Images/icon.bus.20.png';
            }
            arrowP.innerText = " → ";
            directionP.innerText = " " + number_ + ": " + connection['direction'];
            return root;
        }

        function arrayContains(needle, arraystack) {
            if (arraystack.indexOf('') != -1) {
                return true;
            }
            return (arraystack.indexOf(needle) > -1);
        }
    </script>
</head>
<body onload="init()">
<div id="black-div" class="fade-in"></div>
<div>
    <div id="update" class="update"></div>
    <div id="clock" class="clock"></div>
</div>
<div id="stations" class="stations"></div>
<div>
    <div id="debugging"></div>
    <ul id="debuggingUl"></ul>
</div>
<div id="copyright" class="copyright">(c) googol42 - Licensed under <a href="http://www.gnu.org/licenses/agpl-3.0.en.html">AGPL</a> Version 3 or any later Version - <a href="https://github.com/googol42/vvs-station-monitor/archive/gh-pages.zip">Source</a> - Proudly made using Linux, git and vim.</p></div>
</body>
</html>
